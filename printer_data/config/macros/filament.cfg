[gcode_macro _FILAMENT_VARIABLES]
variable_default_extruder_temp: 230   # default extruder temperature for loading/unloading filament
variable_filament_path_length: 95     # length of filament path to load/unload

# Do not remove the next lines
gcode:


[gcode_macro CHANGE_FILAMENT]
description: Do a PAUSE, park the toolhead over the purge bucket and unload the filament
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _FILAMENT_VARIABLES"].default_extruder_temp)|float %}

 	SAVE_GCODE_STATE NAME=CHANGE_FILAMENT_state
    PAUSE
    UNLOAD_FILAMENT
    RESTORE_GCODE_STATE NAME=CHANGE_FILAMENT_state


[gcode_macro UNLOAD_FILAMENT]
description: Basic unload of the filament (used with M600/CHANGE_FILAMENT)
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _FILAMENT_VARIABLES"].default_extruder_temp)|float %}
    {% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _FILAMENT_VARIABLES"].filament_path_length)|float %}

	SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_state
    
    GOTO_BUCKET
    _LOW_TEMP_CHECK TEMP={TEMP}
    _TIP_SHAPING
    M83
    G1 E-{DISTANCE|float} F3000

	RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_state


[gcode_macro LOAD_FILAMENT]
description: Basic load of the filament (used with M600/CHANGE_FILAMENT)
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _FILAMENT_VARIABLES"].default_extruder_temp)|float %}
    {% set DISTANCE = params.DISTANCE|default(printer["gcode_macro _FILAMENT_VARIABLES"].filament_path_length)|float %}

	SAVE_GCODE_STATE NAME=LOAD_FILAMENT_state
    GOTO_BUCKET
	_LOW_TEMP_CHECK TEMP={TEMP}
    M83
	G92 E0
    G1 E{DISTANCE-50|float} F200
    G1 E50 F150
	G92 E0

    RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_state


[gcode_macro _TIP_SHAPING]
description: Filament tip shaping sequence
gcode:
    {% set TEMP = params.TEMP|default(printer["gcode_macro _FILAMENT_VARIABLES"].default_extruder_temp)|float %}

	SAVE_GCODE_STATE NAME=TIP_SHAPING_state
	_LOW_TEMP_CHECK TEMP={TEMP}
    
    {% set old_pressure_advance = printer.extruder.pressure_advance|default(0) %} # old pressure advance
    # we suppress pressure advance
    SET_PRESSURE_ADVANCE ADVANCE=0

    M82
    G92 E0
    G1 E2 F3000
    G1 E0 F3000
    G1 E3 F3000
    G1 E0 F3000
    G1 E4 F3000
    G1 E0 F3000

    # set last pressure advance
    SET_PRESSURE_ADVANCE ADVANCE={old_pressure_advance}
	RESTORE_GCODE_STATE NAME=TIP_SHAPING_state

[gcode_macro _LOW_TEMP_CHECK]
description: Check the nozzle is at temperature and heat it if needed
gcode: 
    {% set TEMP = params.TEMP|default(printer["gcode_macro _FILAMENT_VARIABLES"].default_extruder_temp)|float %}

    {% if printer.extruder.target != 0 %}
        {% if printer.extruder.temperature < printer.extruder.target %}
            M109 S{printer.extruder.target|float} 
        {% endif %}
    {% else %}
        {% if printer.extruder.target < TEMP %}
            M109 S{TEMP}
        {% endif %}
    {% endif %}
